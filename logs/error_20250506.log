2025-05-06 02:18:37,172 - trading_system.trading_system - ERROR - [trading_system.py:686] - Lỗi khi huấn luyện agent: Graph execution error:

Detected at node 'dqn_agent_q_network/hidden_0/MatMul' defined at (most recent call last):
    File "E:\AI_AGENT\automated-trading-system\main.py", line 58, in <module>
      sys.exit(main())
    File "E:\AI_AGENT\automated-trading-system\main.py", line 46, in main
      args.func(args, trading_system)
    File "E:\AI_AGENT\automated-trading-system\cli\commands\train_commands.py", line 289, in handle_train_command
      success, model_path = asyncio.run(system.train_agent(
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\runners.py", line 44, in run
      return loop.run_until_complete(main)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\base_events.py", line 634, in run_until_complete
      self.run_forever()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\windows_events.py", line 321, in run_forever
      super().run_forever()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\base_events.py", line 601, in run_forever
      self._run_once()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\base_events.py", line 1905, in _run_once
      handle._run()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\events.py", line 80, in _run
      self._context.run(self._callback, *self._args)
    File "E:\AI_AGENT\automated-trading-system\trading_system.py", line 669, in train_agent
      training_history = trainer.train()
    File "E:\AI_AGENT\automated-trading-system\models\training_pipeline\trainer.py", line 271, in train
      eval_rewards = self.evaluate()
    File "E:\AI_AGENT\automated-trading-system\models\training_pipeline\trainer.py", line 428, in evaluate
      action = self.agent.act(state, explore=False)
    File "E:\AI_AGENT\automated-trading-system\models\agents\dqn_agent.py", line 191, in act
      q_values = self.q_network.predict(state)
    File "E:\AI_AGENT\automated-trading-system\models\networks\value_network.py", line 371, in predict
      return self.model.predict(state, batch_size=batch_size)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2253, in predict
      tmp_batch_outputs = self.predict_function(iterator)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2041, in predict_function
      return step_function(self, iterator)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2027, in step_function
      outputs = model.distribute_strategy.run(run_step, args=(data,))
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2015, in run_step
      outputs = model.predict_step(data)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 1983, in predict_step
      return self(x, training=False)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 557, in __call__
      return super().__call__(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\base_layer.py", line 1097, in __call__
      outputs = call_fn(inputs, *args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 96, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\functional.py", line 510, in call
      return self._run_internal_graph(inputs, training=training, mask=mask)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\functional.py", line 667, in _run_internal_graph
      outputs = node.layer(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\base_layer.py", line 1097, in __call__
      outputs = call_fn(inputs, *args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 96, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\layers\core\dense.py", line 241, in call
      outputs = tf.matmul(a=inputs, b=self.kernel)
Node: 'dqn_agent_q_network/hidden_0/MatMul'
In[0] and In[1] has different ndims: [32] vs. [3722,64]
	 [[{{node dqn_agent_q_network/hidden_0/MatMul}}]] [Op:__inference_predict_function_1578498]
Traceback (most recent call last):
  File "E:\AI_AGENT\automated-trading-system\trading_system.py", line 669, in train_agent
    training_history = trainer.train()
  File "E:\AI_AGENT\automated-trading-system\models\training_pipeline\trainer.py", line 271, in train
    eval_rewards = self.evaluate()
  File "E:\AI_AGENT\automated-trading-system\models\training_pipeline\trainer.py", line 428, in evaluate
    action = self.agent.act(state, explore=False)
  File "E:\AI_AGENT\automated-trading-system\models\agents\dqn_agent.py", line 191, in act
    q_values = self.q_network.predict(state)
  File "E:\AI_AGENT\automated-trading-system\models\networks\value_network.py", line 371, in predict
    return self.model.predict(state, batch_size=batch_size)
  File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 70, in error_handler
    raise e.with_traceback(filtered_tb) from None
  File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\tensorflow\python\eager\execute.py", line 54, in quick_execute
    tensors = pywrap_tfe.TFE_Py_Execute(ctx._handle, device_name, op_name,
tensorflow.python.framework.errors_impl.InvalidArgumentError: Graph execution error:

Detected at node 'dqn_agent_q_network/hidden_0/MatMul' defined at (most recent call last):
    File "E:\AI_AGENT\automated-trading-system\main.py", line 58, in <module>
      sys.exit(main())
    File "E:\AI_AGENT\automated-trading-system\main.py", line 46, in main
      args.func(args, trading_system)
    File "E:\AI_AGENT\automated-trading-system\cli\commands\train_commands.py", line 289, in handle_train_command
      success, model_path = asyncio.run(system.train_agent(
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\runners.py", line 44, in run
      return loop.run_until_complete(main)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\base_events.py", line 634, in run_until_complete
      self.run_forever()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\windows_events.py", line 321, in run_forever
      super().run_forever()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\base_events.py", line 601, in run_forever
      self._run_once()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\base_events.py", line 1905, in _run_once
      handle._run()
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\asyncio\events.py", line 80, in _run
      self._context.run(self._callback, *self._args)
    File "E:\AI_AGENT\automated-trading-system\trading_system.py", line 669, in train_agent
      training_history = trainer.train()
    File "E:\AI_AGENT\automated-trading-system\models\training_pipeline\trainer.py", line 271, in train
      eval_rewards = self.evaluate()
    File "E:\AI_AGENT\automated-trading-system\models\training_pipeline\trainer.py", line 428, in evaluate
      action = self.agent.act(state, explore=False)
    File "E:\AI_AGENT\automated-trading-system\models\agents\dqn_agent.py", line 191, in act
      q_values = self.q_network.predict(state)
    File "E:\AI_AGENT\automated-trading-system\models\networks\value_network.py", line 371, in predict
      return self.model.predict(state, batch_size=batch_size)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2253, in predict
      tmp_batch_outputs = self.predict_function(iterator)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2041, in predict_function
      return step_function(self, iterator)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2027, in step_function
      outputs = model.distribute_strategy.run(run_step, args=(data,))
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 2015, in run_step
      outputs = model.predict_step(data)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 1983, in predict_step
      return self(x, training=False)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\training.py", line 557, in __call__
      return super().__call__(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\base_layer.py", line 1097, in __call__
      outputs = call_fn(inputs, *args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 96, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\functional.py", line 510, in call
      return self._run_internal_graph(inputs, training=training, mask=mask)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\functional.py", line 667, in _run_internal_graph
      outputs = node.layer(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 65, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\engine\base_layer.py", line 1097, in __call__
      outputs = call_fn(inputs, *args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\utils\traceback_utils.py", line 96, in error_handler
      return fn(*args, **kwargs)
    File "C:\Users\MAY10\anaconda3\envs\autotrading_env\lib\site-packages\keras\layers\core\dense.py", line 241, in call
      outputs = tf.matmul(a=inputs, b=self.kernel)
Node: 'dqn_agent_q_network/hidden_0/MatMul'
In[0] and In[1] has different ndims: [32] vs. [3722,64]
	 [[{{node dqn_agent_q_network/hidden_0/MatMul}}]] [Op:__inference_predict_function_1578498]
2025-05-06 02:18:37,183 - trading_system.train_command - ERROR - [train_commands.py:327] - Huấn luyện thất bại
